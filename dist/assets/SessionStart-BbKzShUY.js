import{P as B,Q as p,b as P,d as C,r as S,a as I,K as N,p as R,X as F,x as T,e as b,o as E,j as U}from"./index-D06XNq7w.js";const M=B("browserSessions",{state:()=>({url:null,pid:null,port:null}),actions:{async startSession(t){var s,i;try{const w=((i=(s=P().user)==null?void 0:s.extension_settings)==null?void 0:i.uiLanguage)||"en",f=await p.get("/browser/new",{params:{service_id:t!=null?t:void 0,uiLanguage:w}}),{pid:d,port:c,url:g}=f.data;return this.pid=d,this.port=c,this.url=g,{pid:d,port:c,url:g}}catch(l){return console.error("Error while starting browser session:",l),null}},async stopSession(t){const s=typeof t=="number"?t:this.pid;if(s)try{await p.post("/browser/stop",{pid:s}),this.pid===s&&(this.pid=null,this.port=null,this.url=null)}catch(i){console.error("Error while stopping session by PID:",i)}},async stopSessionByPort(t){const s=typeof t=="number"?t:this.port;if(s)try{await p.post("/browser/stop",{port:s}),this.port===s&&(this.pid=null,this.port=null,this.url=null)}catch(i){console.error("Error while stopping session by port:",i)}},async stopAllSessions(t=!1){try{await p.post("/browser/stop_all",t?{clean:!0}:{}),this.pid=null,this.port=null,this.url=null}catch(s){console.error("Error while stopping all sessions:",s)}},async listSessions(){try{return(await p.get("/browser/list")).data}catch(t){return console.error("Error while listing sessions:",t),null}}}}),y={BASE_URL:"/ai-bot-front-new/",DEV:!1,LEGACY:!1,MODE:"production",PROD:!0,SSR:!1},O={class:"fixed inset-0"},V=["src"],j=C({__name:"SessionStart",setup(t){const s=S(null),i=S(!1),l=S(!1),w=I(),f=M(),d=P(),c=N(),{checkPluginInstalled:g}=F();let h=null,u=null;const _=()=>{const r=w.params.id,e=r?Number(r):NaN;return Number.isFinite(e)?e:null},k=(r,e)=>{let n=document.querySelector("link[rel='icon']");n||(n=document.createElement("link"),n.rel="icon",document.head.appendChild(n)),n.type=e,n.href=r},x=()=>{h!==null&&(clearTimeout(h),h=null),u&&(window.removeEventListener("app:plugin-status",u),u=null)};R(async()=>{const r=_();await c.fetchData();const e=await g();console.log("Plugin check result:",e),e.isInstalled?(console.log("Plugin already installed, starting session..."),i.value=!0,m(r)):(u=n=>{const{pluginInstalled:o,pluginSkipped:a}=n.detail||{};console.log("SessionStart: Plugin status received:",{pluginInstalled:o,pluginSkipped:a}),(o||a)&&(console.log("SessionStart: Starting session logic..."),i.value=!0,m(r))},window.addEventListener("app:plugin-status",u),console.log("Plugin not installed, showing modal..."),window.dispatchEvent(new CustomEvent("app:check-plugin-status")))});const m=async r=>{if(!i.value){console.log("Cannot start session: plugin not installed and not skipped");return}if(l.value||s.value){console.log("Session already started, skipping duplicate call");return}try{l.value=!0,console.log("Starting session logic...");const e=await f.startSession(r);if(!e){console.error("Failed to start browser session",e),l.value=!1;return}s.value=e.url,h=window.setTimeout(()=>{window.dispatchEvent(new CustomEvent("app:hide-loader"));const n=r?c.getById(r):void 0,o=n==null?void 0:n.params;if(o!=null&&o.title&&typeof o.title=="string"&&o.title.length>0&&(document.title=o.title),o!=null&&o.icon&&typeof o.icon=="string"&&o.icon.length>0){const a=o.icon,D=/^https?:\/\//i.test(a),L=(y==null?void 0:y.VITE_APP_DOMAIN)||"",v=D?a:"".concat(L).concat(a),A=v.endsWith(".ico")?"image/x-icon":"image/png";k(v,A)}},5250),d.update({browser_session_pid:e.pid}).catch(n=>{console.error("Failed to save PID to user:",n)})}catch(e){console.error("Error in startSessionLogic:",e),l.value=!1}};return T(()=>{x()}),(r,e)=>(E(),b("div",O,[s.value?(E(),b("iframe",{key:0,src:s.value,class:"fixed inset-0 w-screen h-screen",style:{border:"0"}},null,8,V)):U("",!0)]))}});export{j as default};
